name: PlatformIO CI/CD

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  push:
    branches:
      - master
      - build-workflow
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  schedule:
    # do a build once a week at 06:07Z Sunday
    - cron: '7 6 * * 0'
  workflow_dispatch:

jobs:
  deploy-on-testboard:
      name: Deploy code on testboard
      runs-on: ubuntu-latest
      steps:
        - name: Get current time
          uses: josStorer/get-current-time@v2.0.2
          id: current-time
        - name: Get testboard response
          uses: indiesdev/curl@v1.1
          id: ttn
          with:
            url: 'https://eu1.cloud.thethings.network/api/v3/as/applications/paxcounter-cicd/packages/storage/uplink_message'
            method: 'GET'
            bearer-token: ${{ secrets.BEARER_TOKEN }}
            headers: '{"Accept": "text/event-stream"}'
            #params: '{"after": "${{ steps.current-time.outputs.time }}", "limit": "1"}'
            params: '{"limit": "1"}'
            log-response: true
        - name: Show response
          #echo contains(fromJSON('pax'), ${{ steps.ttn.outputs.response }})
          run: |
            echo ${{ steps.ttn.outputs.response }}
            echo ${{ fromJson(steps.ttn.outputs.response).data.result.uplink_message.decoded_payload.pax }}
            echo ${{ fromJson(steps.ttn.outputs.response).result.uplink_message.decoded_payload.pax }}
            echo ${{ fromJson(steps.ttn.outputs.response).uplink_message.decoded_payload.pax }}