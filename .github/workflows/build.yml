name: PlatformIO CI/CD

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  push:
    branches:
      - master
      - build-workflow
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  schedule:
    # do a build once a week at 06:07Z Sunday
    - cron: '7 6 * * 0'
  workflow_dispatch:

jobs:
  

  deploy-on-testboard:
      name: Deploy code on testboard
      runs-on: windows-latest
      steps:
        - name: Get current time
          uses: josStorer/get-current-time@v2.0.2
          id: current-time
        - name: Show time
          run: echo ${{ steps.current-time.outputs.time }}
        - name: Wait 120 secons
          run: sleep 120s
          shell: bash
        - name: Query testboard
          uses: indiesdev/curl@v1.1
          id: ttn
          with:
            url: 'https://eu1.cloud.thethings.network/api/v3/as/applications/paxcounter-cicd/packages/storage/uplink_message?order=-received_at&field_mask=up.uplink_message.decoded_payload,up.uplink_message.frm_payload'
            method: 'GET'
            bearer-token: ${{ secrets.BEARER_TOKEN }}
            headers: '{"Accept": "text/event-stream"}'
            params: '{"after": "${{ steps.current-time.outputs.time }}"}'
            log-response: true
        - name: Check testboard response
          run: 
            echo ${{ fromJson(steps.ttn.outputs.response).data.result.uplink_message.decoded_payload.pax }}