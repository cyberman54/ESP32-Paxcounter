name: PlatformIO CI/CD

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  push:
    branches:
      - master
      - build-workflow
    paths-ignore:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'LICENSE'
      - 'README.md'
  schedule:
    # do a build once a week at 06:07Z Sunday
    - cron: '7 6 * * 0'
  workflow_dispatch:

jobs:
  

  deploy-on-testboard:
      name: Deploy code on testboard
      runs-on: windows-latest
      steps:
        - name: Wait 120 secons
          run: sleep 6s
          shell: bash
        - name: Query testboard
          uses: indiesdev/curl@v1.1
          id: ttn
          with:
            #Get latest uplink message from testboard
            url: 'https://eu1.cloud.thethings.network/api/v3/as/applications/paxcounter-cicd/packages/storage/uplink_message?f_port=1&order=-received_at&limit=1&field_mask=up.uplink_message.decoded_payload'
            method: 'GET'
            bearer-token: ${{ secrets.BEARER_TOKEN }}
            headers: '{"Accept": "text/event-stream"}'
            log-response: true
        - name: Check testboard response
          run: 
            echo ${{ fromJson(steps.ttn.outputs.response).data.result.uplink_message.decoded_payload.pax }}